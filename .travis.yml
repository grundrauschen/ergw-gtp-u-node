language: generic
sudo: required
services:
  - docker

deploy:
  provider: packagecloud
  repository: "ci"
  username: "ergw"
  token:
    secure: "K5/mJAu77siVHj4YTELYdqjwhsnSExV60asWCn718PfjHulgzXpQhraFlvn9PxRVmtUYe9nh6F3wzNJKO76Hruc9BpaDRnzd89Ze0dsHaCSWI82zZ7jNRnU2N2ScPF8d3EXm91VePkpKBa/3Q98ZgbA4vOb8ZJ9T5xKOPqbDA1Vr+7s3kN95uOljcDluSj/SDAn6fp+yUI47acecgtTTAI402f7DAu+DM+OSrPc/JuN8ecPX3TyWZNRTkvfaet1VtHvifItYv331x1dBvWA5XiQZz6dpkVg9EcFbLh/gOeHzpKmDTV6wWq+go3R2M+G+Y1x1l95QRjCyWbFtpcgqp7oAJNk5dRVlNnNs8wW5mR2l4oe2RucMtWnch0eVWK0i0PV5TPljGfHOGnvKhGWaCTJe5RWrqyfF4CvbsO00jRFRNlQPMXgnnOtr23PhFzvciImy4a0gZV569Lgk40Uwh/f+8BOnigkdfoJqVXwiMVGQDHDJYYK8MPBklLGrHp2wP6tpg4Ik2jW45BBlb74XyFvgC7SsqwXaKdzRityWVOwB1TlCK5QGwxgEvrgjQ3fDgtrYqp1kw+cxMKkBF5K6lWyYL5q7DQWOEopAmH6/uoJ3UPbAcqYR3JTzI/hQZXYqLUjYe8/RJUWbiBm//2YX3eVAdlB5dS/WGiTuFUIU3eY="
  dist: "ubuntu/xenial"
  skip_cleanup: true
  package_glob: artifacts/*.deb

env:
  global:
    - BUILD_IMAGE="grundrausch3n/ergw-gtp-u-node-base"
    - DOCKER_USERNAME="grundrausch3n"
    - secure: "Tox/AAAKjABSAEFyy5M3G8ZspKE9giZ55Ikbp6H5RGEYrg4Jh7rk3mxAqpQO+8OBqFyF9+tpvEIZ0r13QY0n6pbSLD5LZHm0dlRXmTvj4aiKfC/tHWuVgGbWviopu50cQ8XAcecqDbrjhUsH2gtudE1rYHqmFtozDo1ONpaPpT0nwlwA6Y/m/MnU5QkxdV+UNGkrkp4oUb22oEXhZzUosButDB7zupg8Ohq3r+j7chaFPs3dp6fgHAmI9H/8dKMiYs0Au8E2BCPuCXIc0yb/4y69PpSpKtUQ1ZfQ20LZw5wIV5/7mjZjhDTpvQyFsaQnOz7jqMklcjgmLfbBWvm9AoIh95j8g28jYWisvzCpgrRRGRmvzRkDxaNek1VYyQRUPsiFguR6rSrEK/5pUC3gT/3YaomTc2EvvQBlaNKM3ArBE4mGIex0T7XhLOqiSlhEl3Tgl39OVwfU1V7xmsGvizIKJmzZxSQog+JXpfHCFUuLo1q/j7JgURjYXBk8n+8qnNNalRV0rvKYpnOLvz6q8vXJRWmGTH77fWqtNOV7uZODqvCXjRrbjRlFlwTA6QjZ4oHiZhnBs5cFs/tClYmKC5AbgsBEv9nGWn1Xv2zDN5xB4iNEZ0ePJsMHUXi8/dpkRlj981bHjkDm9DhfShMvvX3ss5AiLA3/qrHZePgULco="

before_install:
  - sudo apt-get -qq update
  - sudo apt-get install -y devscripts
  - docker build -t ergw -f priv/Dockerfile priv

script:
  - export SHORT_COMMIT_ID=$(git rev-parse --verify --short $TRAVIS_COMMIT)
  - debchange -m -l "+$TRAVIS_JOB_NUMBER+git$SHORT_COMMIT_ID" 'Automatically built'
  - mkdir artifacts
  - docker run -v `pwd`:/build ergw
    sh -c "
      dpkg-buildpackage -b -uc -nc && cp ../*deb artifacts
    "
  - docker build -t $BUILD_IMAGE -f docker/Dockerfile . 

after_success:
  - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD";
  - docker push $BUILD_IMAGE 
  - echo "docker push done"

notifications:
  slack:
  - secure: "bwk2/vd/EcAEzb9p31G+eI6VscKTlpX5glh2oL31M/5QmWgjPpa1tHwLck11HjNHBdKcnQ2Po9axTn09gMnUGP9XpnYgvmCdx10Qnry4S1O0i2DDICW8txXQY7POUoFGAlbfIVLevsx4Z4RJn1lqivRfQ+t6eHVa8uYobjpwrymg9Xgtq7+nIk08zXZn6OIRPJZT+YdmJKA74SGk/l6FAoqhVNjDVd6IgmAuYTUeqwQfl3Y4dxPCgqeJTovyb0z79dHSGmqSQxqw9sMAE7U+fq8b2c8BvUOb5dJp/Kd2HyNLgKSnt0KtcvKKnRhwYCLorctc9hoYnl9dvfwqm1UgR9mdWDDbu470j4xj5s8HWr1+zCqw2eSooBLPRbE8Qoe9I2OZ3NhryduGNIsRLW1A32TCemsRXZG6h96Sun/YZuEREKCzNR8Kdj35m6Mxj/aBbSE7ALWK3QjHq5Z4SV/UMRGtCRlm/WK+AO10cxSH7E1siud++5ZwtIogFQPZB40uJOlKnIDmyirk8jX2Vojkcy5/xG+HFeUQkXmM1JtAEIhrGOS2hZcs79jqGGEXoCOJ0MSxtdlkh03Z+eu7gJmAel0lrZ9sEv2NxXqDexti+HxYdpDzu4Gwy8d4NjhYMaITjsJyy6v1gQfy8W3bJkCzvb1GpebY3iWS72HUXXrMJ9g="

branches:
  only:
    - master
